# Router Module

This service uses [Apollo Router](https://www.apollographql.com/docs/router/) to serve the GraphQL supergraph and route
requests to the appropriate subgraph.

[Rover](https://www.apollographql.com/docs/rover) will run on subgraph changes and generate a new supergraph for Router
to serve.

# Module Structure

The repository structure is as follows:

```
├── config            # Configuration files for Rover and Router
├── helm              # Helm chart for deployment
├── schemas           # GraphQL schemas for subgraphs
│   ├── auth          # Auth Module subpgraph
│   ├── organization  # Organization Module subpgraph
│   ├── projects      # Projects Module subpgraph
├── build_graph.sh    # Shell script for generating the supergraph
├── Dockerfile        # Dockerfile for Rover
└── README.md         # Module documentation
```

# Config Files

## Container Setup

The supergraph is generated within the `initContainer` using the Rover cli.

The Dockerfile and Skaffold takes care of including the right `.graphql` files and copying them into the container.
The `supergraph-config.yaml`'s paths is therefore scoped to the container and not the git repo.

## SuperGraph Config

The supergraph config looks like this:

```yaml
# supergraph-config.yaml

federation_version: =2.9.0
subgraphs:
  auth:
    routing_url: "http://localhost:7001/api/graphql"
    schema:
      file: /app/schemas/auth.graphql
  ...
```

The routing_url should match the one given in the `skaffold.yaml` file.
In production a different `supergraph-config.yaml` file will be used.

The supergraph is generated by rover - see commands below.

## Router Config

The router configuration looks like this:

```yaml
# router.yaml

supergraph:
  path: /graphql
  listen: 0.0.0.0:4000
  
...

cors:
  origins: # Specific Origin required with allow credentials set to true.
    - ${env.CLIENT_ORIGIN:-http://localhost:8000}
  allow_credentials: true
  
...

override_subgraph_url:
  auth: ${env.AUTH_URL:-http://localhost:7001}
```

This config is copied to the container and used in production.
The runtime supports reading environment variables and replacing them for the config file.


# Build Rover Docker Image

```shell
docker build -t rover .
```

# Installing Dependencies Locally
Should only be done for debugging purposes.

### Router

```shell
curl -sSL https://router.apollo.dev/download/nix/latest | sh
```

### Rover

```shell
curl -sSL https://rover.apollo.dev/nix/latest | sh
```

# Running Locally
Should only be done for debugging purposes.
The `supergraph.graphql` file should first be generated by Rover and then used by Router.

### Rover

```shell
rover supergraph compose --config ./config/supergraph-config-local.yaml > config/supergraph.graphql
```

### Router

```shell
./router --config config/router.yaml --supergraph config/supergraph.graphql
```